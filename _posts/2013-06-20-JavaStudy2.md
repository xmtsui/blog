---
layout: post
title: Java随笔2
categories:
- Java
---
实现`java.util.*` Vector和ArrayList序列化的分析  
在写jdk util库的时候，经常会被一些细节问题搞的晕头转向。之前是静态私有内部类的问题。这次是Vector与ArrayList的实现定义的存储结构上。  
* `ArrayList: private transient Object[] elementData;`
* `Vector: protected Object[] elementData;`

先说一下transient关键词
 > Java语言的关键字，变量修饰符，如果用transient声明一个实例变量，当对象存储时，它的值不需要维持。这里的对象存储是指，Java的serialization提供的一种持久化对象实例的机制。当一个对象被序列化的时候，transient型变量的值不包括在序列化的表示中，然而非transient型的变量是被包括进去的。使用情况是：当持久化对象时，可能有一个特殊的对象数据成员，我们不想用serialization机制来保存它。为了在一个特定对象的一个域上关闭serialization，可以在这个域前加上关键字transient。

ArrayList是实现了Serializable接口的，ArrayList如何序列化呢？    
ArrayList实现了writeObject方法，方法的实现上只保存非null的数组位置上的数据。即list的长度个elementData。
（arraylist也实现了fast-fail机制，提供弱一致性）  
Vector也实现了writeObject方法，但方法并没有像ArrayList一样进行优化存储，实现语句是data = elementData.clone();clone()的时候会把null值也拷贝。  所以保存相同内容的Vector与ArrayList，Vector的字节数应该比ArrayList要多。

为了验证，我做了一个测试。  
序列化存储了相同内容的Vector与ArrayList，分别到一个文本文件中去。
* Vector需要243字节
* ArrayList需要135字节

设计初衷分析：  

ArrayList是非同步实现的一个单线程下较为高效的数据结构，相比Vector来说。  
ArrayList只通过一个修改记录字段提供弱一致性，主要用在迭代器里。没有同步方法。  
ArrayList的存储结构定义为transient，重写writeObject来实现自定义的序列化，优化了存储。  
而Vector是多线程环境下更为可靠的数据结构，所有方法都实现了同步。  

而关于为什么Vector没有在序列化的时候跟ArrayList一样去优化存储，这个问题没考虑清楚。  
有了解的还欢迎交流。作者邮箱：tsui.uestc@gmail.com  
同时附上Vector与ArrayList的对比  
* API：Vector多了addElement(E e)之类的方法  
* 同步处理：Vector同步，ArrayList非同步  

数据增长性
* Vector缺省情况下自动增长原来一倍的数组长度，ArrayList是原来的50%
* Vector指定了initialCapacity，capacityIncrement来初始化的时候，每次增长capacityIncrement
* 使用模式基本相同

所以如果你要在集合中保存大量的数据那么使用Vector有一些优势，因为你可以通过设置集合的初始化大小来避免不必要的资源开销。
ArrayList自动扩大容量为原来的1.5倍（实现的时候，方法会传入一个期望的最小容量，若扩容后容量仍然小于最小容量，那么容量就为传入的最小容量。扩容的时候使用的Arrays.copyOf方法最终调用native方法进行新数组创建和数据拷贝）

在\\《Practical Java\\》一书中Peter Haggar建议使用一个简单的数组（Array）来代替Vector
或ArrayList。尤其是对于执行效率要求高的程序更应如此。因为使用数组(Array)避免了同步、额外
的方法调用和不必要的重新分配空间的操作。

参考  
1. ArrayList，Vector区别  
<http://xinklabi.iteye.com/blog/1882251>
<http://blog.csdn.net/skill1986/article/details/6771528>  
2. failfast机制  
<http://blog.csdn.net/lianyu2008/article/details/4651451>  
3. java util包分析（里面Vector分析有点瑕疵，针对范型编程的时候不是存储什么类型都可以，有空再分析）  
<http://blog.tianya.cn/blogger/post_show.asp?BlogID=229728&PostID=10038711>  
4. Vector ArrayList的序列化方面的区别  
<http://www.oschina.net/question/587433_76759?sort=time>
<http://www.coderanch.com/t/585905/java/java/Difference-serialization-Vector-ArrayList>
<http://stackoverflow.com/questions/9848129/why-does-arraylist-use-transient-storage/9848179#9848179>
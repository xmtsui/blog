---
layout: post
title: 消息初探
categories:
- MOM
---

###发送消息
有了订阅关系，有了确认机制保证可靠，接下来就可以发送消息了。
- 消息按状态分类
    - Committed消息
    - half消息
- 发送端在发消息时，也分为两种情况
    - Committed消息就是简单消息，当消息中心收到该消息就立即往Subscriber转发。
    - Half消息是事务消息，当事务成功完成，消息会变成Committed的状态。 
    - Half消息需要两阶段提交

###投递消息
根据订阅关系找到订阅端。根据`投递策略?`，随机挑一台订阅端进行投递`为何是随机挑一台`
![dispatcher架构](/tsui/assets/pic/dispacher.png)

###恢复消息
- 发送成功就ok了。如果发送失败了，就需要`恢复出消息(从哪里恢复？数据库)`进行重试投递的时候是只针对投递失败的分组。
- 恢复消息的重试策略，根据配置的时间间隔重试


###消息中心与稳定性
- 应用分级
- DB分库 `为何又用oracle,又用mysql？`
- 消息缓冲池
- 接收端故障隔离
- 消息本地事务`为什么使用本地消息？`
- 开发环境分组

###消息中心的发展
1. 更多分级
    - 文件，内存持久化
2. 更低成本
    - 应用级可靠MySQL
3. 更大客户端集群规模
    - 连接数问题
    - 故障传递，隔离
4. 更灵活使用场景
    - 批量消息拉模式
    - 消息接收顺序
5. 管控能力
    - 集中式管控能力

>需要思考的问题
>客户端集群越来越大
>>服务器连接数急剧增加
>>>而且服务器扩容都没用
>>>>怎么办？

###参考
[消息中心-FAQ](http://doc.alipay.net/pages/viewpage.action?pageId=11255003)  
[消息中心-使用规约](http://doc.alipay.net/pages/viewpage.action?pageId=23536203)  
[消息中心-文档](http://doc.alipay.net/pages/viewpage.action?pageId=11255005)  
[消息分组-SofaOPS](http://sofaops.alipay.net/ops/ConfregModule.html)  